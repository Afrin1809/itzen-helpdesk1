<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ITZen-AI â€” Home & Helpdesk (Single-file full chat)</title>
<style>
  :root{ --muted:#dce8f2; --accent:#003366; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,Helvetica,sans-serif}
  body{
    background: url('background.jpg') no-repeat center/cover;
    display:flex;align-items:center;justify-content:center;padding:24px;
    transition: background 220ms ease;
  }
  .page{ width:78%; max-width:1050px; border-radius:18px; overflow:hidden; transition:opacity 180ms ease; }
  .front-card{ padding:60px 40px; border-radius:30px; background:rgba(0,0,0,0.55); border:1px solid rgba(255,255,255,0.12); text-align:center; color:#eaffff; }
  .profile{ width:90px;height:90px;margin:0 auto 18px;border-radius:15px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;box-shadow:0 0 25px rgba(0,255,255,0.25); }
  h1.front-title{ color:cyan;font-size:48px; letter-spacing:3px; margin-bottom:8px }
  p.tagline{ font-size:20px; opacity:0.95; margin-bottom:28px }
  .btn-row{ display:flex; justify-content:center; gap:24px; flex-wrap:wrap }
  .btn{ padding:14px 36px;border-radius:40px;border:none;cursor:pointer;font-size:18px;font-weight:700;background:linear-gradient(45deg, cyan,#0088ff); color:#000 }
  .chat-root{ display:flex; width:100%; height:100vh; min-height:600px; box-shadow:0 0 90px rgba(0,51,102,0.45); border-radius:0; border:none; background:linear-gradient(180deg,#003366,#000); color:var(--muted); overflow:hidden; }
  .sidebar{ width:320px; padding:22px 20px; display:flex;flex-direction:column; gap:18px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06)); }
  .brand{display:flex;align-items:center;gap:14px}
  .logo{ width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#001f3d);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:20px;box-shadow:0 6px 20px rgba(0,51,102,0.45); border:1px solid rgba(255,255,255,0.06)}
  .title{font-weight:800;color:#fff;font-size:18px}
  .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
  .quick-actions{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .quick-btn{ background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid rgba(255,255,255,0.04); padding:12px;border-radius:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:600 }
  .info{ margin-top:auto; padding-top:10px; border-top:1px solid rgba(255,255,255,0.02); font-size:13px }
  .chat-area{ flex:1; display:flex; flex-direction:column; min-height:0 }
  .messages{ flex:1;padding:26px;overflow:auto;display:flex;flex-direction:column;gap:14px;background-image:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
  .msg{ max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.4;font-size:14px }
  .bot{ align-self:flex-start;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); color:#e6eef8; box-shadow:0 6px 18px rgba(0,0,0,0.45); }
  .user{ align-self:flex-end;background:linear-gradient(180deg, rgba(0,51,102,0.12), rgba(0,51,102,0.06)); border:1px solid rgba(0,51,102,0.18); color:#fff; font-weight:600; box-shadow:0 6px 18px rgba(0,51,102,0.18); }
  .input-area{ padding:14px; border-top:1px solid rgba(255,255,255,0.03); display:flex; gap:8px; align-items:center; background: linear-gradient(180deg, rgba(0,0,0,0.04), rgba(0,0,0,0.08)); }
  .input{ flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.03); color:var(--muted) }
  .send{ background:var(--accent); border:none; padding:10px 14px; border-radius:12px; color:white; cursor:pointer; font-weight:700 }
  .clear{ background:transparent;border:1px solid rgba(255,255,255,0.04); padding:8px 12px;border-radius:10px;color:var(--muted); cursor:pointer }
  .chip{ padding:8px 12px;border-radius:999px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); color:#fff;border:1px solid rgba(255,255,255,0.06); font-weight:600; cursor:pointer }
  .suggestions{ padding:12px 24px; border-top:1px dashed rgba(255,255,255,0.03); display:flex; flex-wrap:wrap; gap:8px; }
  .solution{ background: linear-gradient(180deg, rgba(255,255,255,0.015), transparent); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03) }
  .solution pre{ white-space:pre-wrap; margin:0; color:var(--muted) }
  .mic-btn{ width:46px;height:46px;border-radius:12px;border:none;background:rgba(0,0,0,0.45);color:var(--muted);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.04) }
  .mic-btn.recording{ background: linear-gradient(135deg,var(--accent), #001f3d); color:white }
  .hidden{ display:none !important }
  .back-home{ margin-left:12px; padding:8px 12px; border-radius:10px; background:rgba(0,0,0,0.45); color:#fff; border:none; cursor:pointer }
  @media (max-width:880px){ .sidebar{ display:none } .chat-root{ height:100vh } .front-card{ padding:36px 18px } }
  .messages::-webkit-scrollbar{ width:10px } .messages::-webkit-scrollbar-thumb{ background: rgba(0,51,102,0.25); border-radius:8px; }
  .ticket-row{ padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.02); margin-top:8px; font-size:13px; display:flex; justify-content:space-between; align-items:center; gap:8px }
  .ticket-meta{ color:var(--muted); font-size:12px; margin-top:6px }
  .small-btn{ padding:6px 8px; border-radius:8px; border:none; background:rgba(0,51,102,0.6); color:#fff; cursor:pointer; font-weight:700; }
  /* ðŸ”¥ Highlight Open Ticket button */
#createTicketBtn {
  background: linear-gradient(135deg, #030f29, #0e3941);
  color: #f3f0f0;
  font-weight: 800;
  border: 1px solid rgba(209, 105, 21, 0.9);
  box-shadow: 0 0 18px rgba(210, 101, 11, 0.7);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#createTicketBtn:hover {
  transform: scale(1.06);
  box-shadow: 0 0 30px rgb(1, 32, 59);
}
@keyframes ticketPulse {
  0%   { box-shadow: 0 0 10px rgba(77, 213, 32, 0.4); }
  50%  { box-shadow: 0 0 26px rgba(26, 158, 92, 0.9); }
  100% { box-shadow: 0 0 10px rgba(22, 94, 39, 0.4); }
}

#createTicketBtn {
  animation: ticketPulse 2s infinite;
}


</style>
</head>
<body>
 <!-- HOME PAGE -->
 <div id="page-home" class="page" role="main" aria-label="ITZen Home">
   <div class="front-card">
     <div class="profile">RG</div>
     <h1 class="front-title">ITZen-AI</h1>
     <p class="tagline">Hello buddy! ðŸ‘‹ Welcome to the IT Helpdesk! Just tell me your issue â€” I'm ready to assist you! ðŸ˜Š</p>
 
     <div class="btn-row">
  <button id="startSupport" class="btn" title="Open Helpdesk Chat">START SUPPORT</button>

  <!-- NEW BUTTON -->
  <button id="changeBg" class="btn" title="Change Background">CHANGE BACKGROUND</button>

  <!-- HIDDEN FILE PICKER -->
  <input type="file" id="bgPicker" accept="image/*" style="display:none;">
</div>

   </div>
 </div>
 <!-- ADMIN LOGIN MODAL -->
<div id="bgLoginModal" class="hidden"
     style="position:fixed; inset:0; background:rgba(0,0,0,0.75);
     display:flex; align-items:center; justify-content:center; z-index:9999;">

  <div style="width:320px; background:#04131a; padding:20px;
              border-radius:14px; border:1px solid rgba(255,255,255,0.1);">
    <h3 style="margin:0 0 12px; color:cyan;">Admin Access</h3>

    <input id="bgUser" placeholder="Username"
           style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;">
    <input id="bgPass" type="password" placeholder="Password"
           style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;">

    <button id="bgLoginBtn"
            style="width:100%; padding:10px; border-radius:8px;
                   background:cyan; font-weight:700; cursor:pointer;">
      OK
    </button>

    <div id="bgLoginMsg"
         style="margin-top:8px; font-size:13px; color:#ffb3b3;"></div>
  </div>
</div>
 <!-- CHAT TEMPLATE -->
 <div id="page-chat" class="hidden" aria-label="Helpdesk Chat" role="application">
   <div id="chatRoot" class="chat-root">
     <aside class="sidebar" aria-hidden="false">
       <div class="brand">
         <div class="logo">RG</div>
         <div>
           <div class="title">ITZen-AI Helpdesk</div>
           <div class="subtitle">JSON-backed KB â€¢ IT Support</div>
         </div>
       </div>
 
       <div>
         <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Popular topics</div>
         <div class="quick-actions" aria-hidden>
           <button class="quick-btn" data-topic="teams" data-label="Teams">Teams <span class="status">â€º</span></button>
           <button class="quick-btn" data-topic="zid" data-label="Zid Password">Zid Password <span class="status">â€º</span></button>
           <button class="quick-btn" data-topic="hp" data-label="Printer / PPM">Printer / PPM <span class="status">â€º</span></button>
           <button class="quick-btn" data-topic="outlook" data-label="Outlook">Outlook <span class="status">â€º</span></button>
           <button class="quick-btn" data-topic="excel" data-label="Excel Macros">Excel Macros <span class="status">â€º</span></button>
         </div>
       </div>
 
       <div class="info">
  <div style="font-weight:700;color:#fff">Need more help?</div>
  <div style="margin-top:8px">
    If suggested solutions don't solve the issue, contact IT at 
    <strong>it.helpdesk@rnaipl.com</strong> or call 
    <strong>04471699000</strong>.
  </div>
</div>

     </aside>
 
     <main class="chat-area" style="min-height:0; display:flex; flex-direction:column;">
       <div style="display:flex;align-items:center;gap:12px;padding:12px 18px">
         <button id="backToHome" class="back-home" title="Back to home">Back to Home</button>
         <div style="font-weight:700;color:#fff">ITZen-AI Helpdesk â€” Chat</div>
         <div style="margin-left:auto;display:flex;gap:8px">
           <button id="createTicketBtn" class="chip" title="Create a quick ticket">Open Ticket</button>
           <button id="uploadKB" class="chip" title="Upload KB">Upload KB</button>
         </div>
       </div>
 
       <div class="messages" id="messages" role="log" aria-live="polite"></div>
       <div class="suggestions" id="suggestions" aria-hidden="true"></div>
 
       <div class="input-area">
         <button id="mic" class="mic-btn" title="Start voice input" aria-label="Start voice input">ðŸŽ¤</button>
         <input id="input" class="input" placeholder="Describe your issue (e.g. 'printer not printing')" aria-label="Type your message" />
         <button id="send" class="send" aria-label="Send message">Send</button>
         <button id="history" class="clear" aria-label="Show search history">History</button>
         <button id="clear" class="clear" aria-label="Clear chat">Clear</button>
       </div>
     </main>
   </div>
 </div>
 
<script>
/* Full chat script with backend-safe KB loading + persistence */
/* This script implements the same behavior as before but with ticket status removed from views. */
 
const homeEl = document.getElementById('page-home');
const chatPageEl = document.getElementById('page-chat');
const chatRoot = document.getElementById('chatRoot');
 
function openChatFull(){
  if(homeEl && homeEl.parentNode) homeEl.parentNode.removeChild(homeEl);
  chatPageEl.classList.remove('hidden');
  document.body.style.background = '#00121a';
  document.body.style.padding = '0';
  document.body.style.justifyContent = 'stretch';
  document.body.style.alignItems = 'stretch';
  if(chatRoot && chatRoot.parentNode && chatRoot.parentNode !== document.body){
    document.body.appendChild(chatRoot);
    chatPageEl.style.display = 'none';
  }
  chatRoot.style.width = '100%';
  chatRoot.style.height = '100vh';
  chatRoot.style.borderRadius = '0';
  chatRoot.style.margin = '0';
  chatRoot.style.overflow = 'hidden';
  if(window.__chatInitialized && typeof window.__chatShowWelcome === 'function') {
    try{ window.__chatShowWelcome(); }catch(e){ /* ignore */ }
  }
}
 
document.getElementById('startSupport').addEventListener('click', (e) => {
  e.preventDefault();
  location.hash = '#chat';
  openChatFull();
});
document.getElementById('backToHome').addEventListener('click', ()=> {
  location.hash = '';
  location.reload();
});
 
// Upload KB navigation - opens the upload.html admin page
document.getElementById('uploadKB').addEventListener('click', () => {
  location.href = 'upload.html';
});
 
/* ======= Chat logic (with backend-safe KB loading + persistence) ======= */
(function(){
  let KB = {};
  let items = [];
  let lastIssueList = [];
  let recognition = null;
  let isRecording = false;
  let searchHistory = [];
  window.__renderingPersisted = false;
 
  const messagesEl = document.getElementById('messages');
  const suggestionsEl = document.getElementById('suggestions');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const clearBtn = document.getElementById('clear');
  const historyBtn = document.getElementById('history');
  const micBtn = document.getElementById('mic');
  const createTicketBtn = document.getElementById('createTicketBtn');
 
  function escapeHtml(str){ return String(str).replace(/[&<>"]/g, function(tag){ const chars = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }; return chars[tag] || tag; }); }
 
  function formatCreatedAt(createdAtStr) {
    if (!createdAtStr) return '';
    const s = String(createdAtStr).trim();
    const humanRegex = /^\d{2}-\d{2}-\d{4}\s+\d{2}:\d{2}\s+(AM|PM)$/i;
    if (humanRegex.test(s)) return s;
    try {
      const d = new Date(s);
      if (isNaN(d.getTime())) return createdAtStr;
      const optsDate = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'Asia/Kolkata' };
      const optsTime = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' };
      const datePart = new Intl.DateTimeFormat('en-GB', optsDate).format(d);
      const timePart = new Intl.DateTimeFormat('en-US', optsTime).format(d);
      const dateDash = datePart.replace(/\//g, '-');
      return `${dateDash} ${timePart}`;
    } catch (e) {
      return createdAtStr;
    }
  }
 
  function addMessage(text, who='bot', allowHtml=false){
    const el = document.createElement('div');
    el.className = 'msg ' + (who==='user' ? 'user' : 'bot');
    el.innerHTML = allowHtml ? text : escapeHtml(text).replace(/\n/g, '<br>');
    messagesEl.appendChild(el);
    messagesEl.scrollTop = messagesEl.scrollHeight;
 
    if(window.__renderingPersisted) return;
    try {
      const plain = allowHtml ? (el.textContent || text) : text;
      backendAddChatMessage(who, plain);
    } catch(e){
      console.warn('saving chat message failed', e);
    }
  }
function speakLongText(text){
  if (!('speechSynthesis' in window)) return;
  if (!text || text.length < 3) return;

  // Stop anything already speaking
  window.speechSynthesis.cancel();

  // Split into safe chunks
  const sentences =
    text.match(/[^.!?]+[.!?]+/g) ||
    text.match(/.{1,120}/g) ||
    [text];

  let index = 0;

  function speakNext(){
    if (index >= sentences.length) return;

    const u = new SpeechSynthesisUtterance(sentences[index].trim());
    u.lang = 'en-IN';
    u.rate = 1;
    u.pitch = 1;

    u.onend = () => {
      index++;
      setTimeout(speakNext, 120); // âœ… CRITICAL delay
    };

    u.onerror = () => {
      index++;
      setTimeout(speakNext, 120);
    };

    window.speechSynthesis.speak(u);
  }

  speakNext();
}

let isSpeaking = false;

function speak(text){
  if(!('speechSynthesis' in window)) return;
  if(!text || text.length < 3) return;

  try{
    const utter = new SpeechSynthesisUtterance(text);

    utter.lang = 'en-IN';
    utter.rate = 1;
    utter.pitch = 1;

    const voices = window.speechSynthesis.getVoices();
    if(voices.length){
      utter.voice =
        voices.find(v => v.lang === 'en-IN') ||
        voices.find(v => v.lang.startsWith('en')) ||
        voices[0];
    }

    utter.onstart = () => { isSpeaking = true; };
    utter.onend   = () => { isSpeaking = false; };
    utter.onerror = () => { isSpeaking = false; };

    window.speechSynthesis.speak(utter);
  } catch(e){
    console.warn('TTS error', e);
  }
}

  function buildItemsFromKB(){ items = []; for(const [id,obj] of Object.entries(KB || {})){ items.push({ id, title: obj.title || id, issues: obj.issues || {} }); } }
 
  function scoreCandidateWithTokens(it, tokens){
    const title = (it.title||'').toLowerCase();
    const issuesText = (Object.keys(it.issues || {}).join(' ') + ' ' + Object.values(it.issues || {}).join(' ')).toLowerCase();
    const combined = title + ' ' + issuesText;
    let score = 0;
    for(const tok of tokens){
      if(title.includes(tok)) score += 2;
      if(issuesText.includes(tok)) score += 1;
      if(tok.length > 4 && combined.includes(tok)) score += 0.2;
    }
    return score;
  }
 
  function searchKBForPhrase(text){
    if(!text) return null;
    const t = text.toLowerCase().trim();
    for(const it of items){ if(it.title.toLowerCase() === t) return it; }
    for(const it of items){ if(it.title.toLowerCase().includes(t)) return it; }
    const tokens = t.split(/\s+/).filter(Boolean);
    if(tokens.length === 0) return null;
    const scored = items.map(it => ({ it, score: scoreCandidateWithTokens(it, tokens) }));
    scored.sort((a,b) => b.score - a.score);
    if(scored.length && scored[0].score > 0) return scored[0].it;
    return null;
  }
 
  function findTopic(text){
    const t = (text||'').toLowerCase();
    if(/\b(hi|hello|hey|hii)\b/.test(t)) return 'greeting';
    if(t.match(/printer|print|ppm|secureprint|badge|card/)) return 'printer';
    if(t.match(/wi-?fi|wifi|network|internet|lan|ethernet|ping/)) return 'network';
    if(t.match(/login|password|sign in|unlock|ipn|zid|pummp/)) return 'login';
    if(t.match(/install|application|software|crash|error|bug/)) return 'software';
    if(t.match(/outlook|mail|email|pst|ost|search|scanpst/)) return 'outlook';
    if(t.match(/excel|macro|macros/)) return 'excel';
    if(t.match(/teams/)) return 'teams';
    return null;
  }
 
  function suggestForTopic(topic){
    if(!topic) return [];
    const t = topic.toLowerCase();
    let direct = items.filter(it => it.id.toLowerCase().includes(t) || it.title.toLowerCase().includes(t));
    if(direct.length) return direct;
    let fallback = items.filter(it => {
      const comb = (it.title + ' ' + Object.keys(it.issues).join(' ') + ' ' + Object.values(it.issues).join(' ')).toLowerCase();
      return comb.includes(t);
    });
    if(fallback.length) return fallback;
    const tokens = t.split(/\s+/).filter(Boolean);
    if(tokens.length){
      const scored = items.map(it => ({ it, score: scoreCandidateWithTokens(it, tokens) }));
      scored.sort((a,b) => b.score - a.score);
      const related = scored.filter(s => s.score > 0).map(s => s.it).filter((v,i,a)=>a.indexOf(v)===i).slice(0,6);
      if(related.length) return related;
    }
    return items.slice(0,6);
  }
 
  function showSuggestions(itemsList){
    suggestionsEl.innerHTML = '';
    lastIssueList = itemsList || [];
    if(!itemsList || itemsList.length===0){ suggestionsEl.setAttribute('aria-hidden','true'); return; }
    suggestionsEl.setAttribute('aria-hidden','false');
    itemsList.forEach((it, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.textContent = it.title;
      btn.onclick = ()=> selectIssue(idx);
      suggestionsEl.appendChild(btn);
    });
  }
  function selectIssue(idx){
  if(!lastIssueList || !lastIssueList[idx]) return;

  const issue = lastIssueList[idx];
  addMessage(issue.title, 'user');

  const iss = issue.issues || {};
  let stepsHTML = '<ol style="padding-left:18px;margin:8px 0">';

  Object.entries(iss).forEach(([k, v]) => {
    const showKey = (k && !k.match(/^Problem$/i) && k !== v);
    const lineTitle = showKey ? `<strong>${escapeHtml(k)}:</strong> ` : '';
    stepsHTML += `<li style="margin-bottom:6px">${lineTitle}${escapeHtml(v)}</li>`;
  });

  stepsHTML += '</ol>';

  const solHTML = `
    <div class="solution">
      <strong>Solution:</strong>
      ${stepsHTML}
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="chip" onclick="markResolved()">Mark as resolved</button>
        <button class="chip" onclick="contactSupport()">Contact support</button>
      </div>
    </div>
  `;

  addMessage(solHTML, 'bot', true);

  // âœ… Speak ALL steps
  const allStepsText = Object.entries(iss)
    .map(([_, val], i) => `Step ${i + 1}. ${val}`)
    .join('. ');

  speakLongText(`${issue.title}. ${allStepsText}`);

  suggestionsEl.innerHTML = '';
  lastIssueList = [];
  }
  window.markResolved = function(){ addMessage('Thank you â€” glad it worked! If you need anything else, type your question.','bot'); speak('Glad it worked.'); }
  window.contactSupport = function(){
  addMessage(
    'You can contact IT support at it.helpdesk@rnaipl.com or call 04471699000. Would you like me to open a ticket for you?',
    'bot'
  );
  speak('You can contact IT support at it dot helpdesk at r n a i p l dot com.');
}


  /* ===== Backend persistence helpers ===== */
  async function backendAddSearchTerm(term){
    try {
      await fetch('/api/search-history', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ term })
      });
    } catch(e){ console.warn('add search failed', e); }
  }
  async function backendFetchSearchHistory(){
    try {
      const res = await fetch('/api/search-history');
      if(!res.ok) return [];
      return await res.json();
    } catch(e){ console.warn('fetch search history failed', e); return []; }
  }
  async function backendClearSearchHistory(){
    try { await fetch('/api/search-history', { method: 'DELETE' }); } catch(e){ console.warn('clear search failed', e); }
  }
  async function backendAddChatMessage(role, content){
    try {
      await fetch('/api/chat-message', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ role, content })
      });
    } catch(e){ console.warn('add chat failed', e); }
  }
  async function backendFetchChatMessages(limit=200){
    try {
      const res = await fetch('/api/chat-messages?limit=' + encodeURIComponent(limit));
      if(!res.ok) return [];
      return await res.json();
    } catch(e){ console.warn('fetch chats failed', e); return []; }
  }
  async function backendClearChatMessages(){
    try { await fetch('/api/chat-messages', { method: 'DELETE' }); } catch(e){ console.warn('clear chat messages failed', e); }
  }
 
  async function backendFetchTickets(){
    try {
      const res = await fetch('/api/tickets');
      if(!res.ok) return [];
      return await res.json();
    } catch(e){ console.warn('fetch tickets failed', e); return []; }
  }
  async function backendFetchTicketById(id){
    try {
      const res = await fetch('/api/tickets/' + encodeURIComponent(id));
      if(!res.ok) return null;
      return await res.json();
    } catch(e){ console.warn('fetch ticket failed', e); return null; }
  }
 
  async function loadHistory() {
    try {
      const backendList = await backendFetchSearchHistory();
      if(backendList && backendList.length){
        searchHistory = backendList.map(x => x.term);
        saveHistory();
        return;
      }
    } catch(e){ }
    const saved = localStorage.getItem('search_history');
    if(saved){ try { searchHistory = JSON.parse(saved); } catch(e){ searchHistory = []; } }
  }
  function saveHistory() { localStorage.setItem('search_history', JSON.stringify(searchHistory)); }
  function addToHistory(term){
    if(!term) return; const t = term.trim(); if(!t) return;
    const idx = searchHistory.indexOf(t); if(idx !== -1) searchHistory.splice(idx, 1);
    searchHistory.unshift(t); if(searchHistory.length > 30) searchHistory = searchHistory.slice(0,30);
    saveHistory();
    backendAddSearchTerm(t);
  }
  function showHistory() {
    suggestionsEl.innerHTML = '';
    if(!searchHistory || searchHistory.length===0){ suggestionsEl.setAttribute('aria-hidden','false'); addMessage('No search history found.', 'bot'); return; }
    suggestionsEl.setAttribute('aria-hidden','false');
    searchHistory.forEach((term, idx) => {
      const chip = document.createElement('button');
      chip.className = 'chip';
      chip.textContent = term;
      chip.onclick = () => { const val = term; handleUserMessage(val); };
      suggestionsEl.appendChild(chip);
    });
    const clearChip = document.createElement('button');
    clearChip.className = 'chip';
    clearChip.style.borderColor = 'rgba(0,51,102,0.6)';
    clearChip.style.color = '#fff';
    clearChip.textContent = 'Clear History';
    clearChip.onclick = async () => {
      localStorage.removeItem('search_history');
      searchHistory = [];
      suggestionsEl.innerHTML = '';
      addMessage('Search history cleared.', 'bot');
      try { await backendClearSearchHistory(); } catch(e){ console.warn('clear backend search failed', e); }
    };
    suggestionsEl.appendChild(clearChip);
  }
 
  function generateGenericAnswer(query){
    const q = (query||'').toLowerCase();
    let area = 'General';
    if(q.includes('printer') || q.includes('print')) area = 'Printer';
    else if(q.includes('outlook') || q.includes('pst') || q.includes('ost') || q.includes('email')) area = 'Outlook/Email';
    else if(q.includes('teams') || q.includes('meeting') || q.includes('audio') || q.includes('video')) area = 'Teams / Meetings';
    else if(q.includes('password') || q.includes('login') || q.includes('sign in')) area = 'Authentication';
    else if(q.includes('excel') || q.includes('macro')) area = 'Excel / Macros';
    else if(q.includes('network') || q.includes('wifi') || q.includes('internet')) area = 'Network';
 
    const steps = [
      `1) Reproduce & Clarify â€” Try to reproduce the issue and note exact error messages, time, and steps.`,
      `2) Basic restart â€” Close the affected app, restart the device or service, and retry.`,
      `3) Check permissions/settings â€” Verify app-specific settings, account permissions, or device access.`,
      `4) Update & Patch â€” Ensure app/OS drivers and updates are installed.`,
      `5) Logs & Diagnostics â€” Collect logs or run built-in diagnostics.`,
      `6) Temporary workarounds â€” Use web apps or alternate devices if available.`,
      `7) Backup & Restore â€” Backup data before repair or restore.`,
      `8) Contact support â€” Provide IT with steps, screenshots and logs if unresolved.`
    ];
    let hints = '';
    if(area === 'Printer'){ hints = 'Hint: For printers, check power/network, paper jams, and reinstall drivers.'; }
    else if(area === 'Outlook/Email'){ hints = 'Hint: Try ScanPST or rebuild OST for Exchange accounts.'; }
    else if(area === 'Teams / Meetings'){ hints = 'Hint: Clear Teams cache and test in web client.'; }
    else if(area === 'Authentication'){ hints = 'Hint: Verify system date/time and clear saved credentials.'; }
    else if(area === 'Excel / Macros'){ hints = 'Hint: Use Trust Center settings for macros.'; }
    else if(area === 'Network'){ hints = 'Hint: Try wired connection and reboot router.'; }
 
    let answer = `I couldn't find an exact KB article for \"${escapeHtml(query)}\". Try these general steps for ${area} issues:\n\n`;
    answer += steps.join('\n') + '\n\n' + hints;
    return answer;
  }
 
  async function handleUserMessage(textRaw){
    const text = (textRaw||'').trim(); if(!text) return; addMessage(text, 'user'); addToHistory(text);
    if(text.toLowerCase().includes('open ticket')){
       try {
        const res = await fetch('/api/ticket', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title: text, description: '' }) });
        if(res.ok){
          const data = await res.json();
          addMessage(
            `Ticket created â€” ID: <strong>${escapeHtml(data.ticket_id)}</strong>` +
            `<div class="ticket-meta">Created at: <strong>${escapeHtml(formatCreatedAt(data.created_at))}</strong></div>` +
            `<div style="margin-top:8px"><button class="small-btn" onclick="viewTicketDetails('${escapeHtml(data.ticket_id)}')">View ticket</button></div>`,
            'bot',
            true
          );
          speak('Ticket created.');
        } else {
          addMessage('Failed to create ticket via backend. Creating demo ticket locally.', 'bot', true);
          addMessage('Ticket ID: <strong>#HD-LOCAL-001</strong>', 'bot', true);
          speak('Created demo ticket.');
        }
      } catch(err){
        console.warn('ticket error',err);
        addMessage('Ticket API not available â€” demo ticket created: <strong>#HD-LOCAL-001</strong>', 'bot', true);
        speak('Created demo ticket.');
      }
      return;
    }
 
    const topic = findTopic(text);
    if(topic === 'greeting'){ addMessage('Hello! ðŸ‘‹ How can I help you today?.','bot', true); speak('Hello! How can I help you today?'); return; }
 
    if(topic){
      const suggested = suggestForTopic(topic).slice(0,6);
      if(suggested.length){ addMessage(`I found these common ${topic} items â€” please choose one:`, 'bot'); lastIssueList = suggested; setTimeout(()=>{ showSuggestions(suggested); }, 120); speak(`I found some common ${topic} items.`); return; }
    }
 
    const found = searchKBForPhrase(text);
    if(found){ lastIssueList = [found]; selectIssue(0); return; }
 
    const tokens = text.toLowerCase().split(/\s+/).filter(Boolean);
    if(tokens.length){
      const scoredAll = items.map(it => ({ it, score: scoreCandidateWithTokens(it, tokens) }));
      scoredAll.sort((a,b)=>b.score - a.score);
      const related = scoredAll.filter(s=>s.score>0).map(s=>s.it).filter((v,i,arr)=>arr.indexOf(v)===i).slice(0,6);
      if(related.length){ addMessage(`I couldn't find an exact match for "${escapeHtml(text)}", but here are related help items â€” please choose one:`, 'bot'); lastIssueList = related; setTimeout(()=>{ showSuggestions(related); }, 120); speak('I found related items â€” please choose the one that matches.'); return; }
    }
 
    const generic = generateGenericAnswer(text);
    const solHTML = `<div class="solution"><strong>Suggested steps:</strong><pre>${escapeHtml(generic)}</pre>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="chip" onclick="markResolved()">Mark as resolved</button>
        <button class="chip" onclick="contactSupport()">Contact support</button>
      </div></div>`;
    addMessage(solHTML, 'bot', true);
    speak('I prepared some general troubleshooting steps. Check the chat for details.');
    const fallbackChips = [
      {title:'Teams issues', id:'__cat_teams', issues: { 'Try': 'Type "teams" or ask about sign-in, audio/video, connectivity, file sharing' }},
      {title:'Printer / PPM', id:'__cat_printer', issues: { 'Try': 'Type "printer" or ask about PPM or badge enrollment' }},
      {title:'Outlook / Mail', id:'__cat_outlook', issues: { 'Try': 'Type "outlook" or ask about PST/OST, search, or startup errors' }},
      {title:'Excel Macros', id:'__cat_excel', issues: { 'Try': 'Type "excel" or ask about enabling macros' }}
    ];
    lastIssueList = fallbackChips; showSuggestions(fallbackChips);
  }
 
  sendBtn.addEventListener('click', ()=>{ const t = inputEl.value.trim(); if(!t) return; inputEl.value=''; handleUserMessage(t); });
  inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });
  clearBtn.addEventListener('click', async ()=>{ messagesEl.innerHTML=''; suggestionsEl.innerHTML=''; addMessage('<strong>Chat cleared.</strong> You can ask anything from the helpdesk KB or start with a topic on the left.','bot', true); try { await backendClearChatMessages(); } catch(e){ console.warn('clear backend chats failed', e); } });
  historyBtn.addEventListener('click', ()=>{ showHistory(); });
 
  document.querySelectorAll('.quick-btn').forEach(b=>{ b.addEventListener('click', ()=>{ const topic = b.getAttribute('data-topic'); const label = b.getAttribute('data-label') || topic; addMessage(label, 'user'); handleUserMessage(label); }); });
 
  function showMicError(msg){
    addMessage(`<strong>Voice error:</strong> ${escapeHtml(msg)}`, 'bot', true);
    console.warn('Voice error:', msg);
  }
 
  function isSpeechRecognitionSupported(){
    return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  }
 
  function setupRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if(!SR) {
      showMicError('SpeechRecognition API not supported in this browser. Please use Chrome or Edge.');
      return null;
    }
 
    const r = new SR();
    r.lang = 'en-IN';

    r.interimResults = false;
    r.maxAlternatives = 1;
 
    r.onresult = (ev) => {
      try {
        const spoken = ev.results[0][0].transcript;
        inputEl.value = spoken;
        setTimeout(()=>{ sendBtn.click(); }, 150);
      } catch(err){
        showMicError('Could not read recognition result: ' + (err.message || err));
      }
    };
 
    r.onend = ()=> {
      isRecording = false;
      micBtn.classList.remove('recording');
      micBtn.title = 'Start voice input';
    };
 
    r.onerror = (ev)=> {
      const errName = ev && ev.error ? ev.error : JSON.stringify(ev);
      if(errName === 'not-allowed' || errName === 'NotAllowedError' || errName === 'PermissionDeniedError'){
        showMicError('Microphone access not allowed. Check browser site settings and Windows/Mac privacy settings, then reload the page.');
      } else if(errName === 'no-speech' || errName === 'NoSpeechError'){
        showMicError('No speech detected. Try speaking louder or check your microphone.');
      } else if(errName === 'not-found' || errName === 'NotFoundError'){
        showMicError('No microphone found. Connect a microphone and verify it is enabled.');
      } else {
        showMicError('Speech recognition error: ' + errName);
      }
      console.warn('Speech recognition error event:', ev);
    };
 
    return r;
  }
 
  async function toggleRecording(){
    if(!isSpeechRecognitionSupported()){
      addMessage('Voice input not supported in this browser. Use Chrome or Edge.', 'bot');
      return;
    }
 
    if(!recognition) recognition = setupRecognition();
    if(!recognition){
      return;
    }
 
    if(isRecording){
      try { recognition.stop(); } catch(e){ }
      isRecording = false;
      micBtn.classList.remove('recording');
      micBtn.title = 'Start voice input';
      return;
    }
 
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => t.stop());
    } catch(err) {
      if(err && (err.name === 'NotAllowedError' || err.name === 'SecurityError' || err.name === 'PermissionDeniedError')){
        showMicError('Microphone permission denied. Please allow microphone access in the address bar (site settings) and OS privacy settings.');
      } else if(err && err.name === 'NotFoundError'){
        showMicError('No microphone found. Connect or enable a microphone and try again.');
      } else {
        showMicError('Microphone permission or device error: ' + (err && err.message ? err.message : String(err)));
      }
      return;
    }
 
    try {
      recognition.start();
      isRecording = true;
      micBtn.classList.add('recording');
      micBtn.title = 'Stop voice input';
    } catch(e){
      showMicError('Failed to start speech recognizer: ' + (e.message || e));
      console.error('recognition.start error', e);
    }
  }
 
  micBtn.addEventListener('click', toggleRecording);
 
  function setupRecognitionFallbackForTests(){
    if('speechSynthesis' in window) window.speechSynthesis.getVoices();
  }
  createTicketBtn.addEventListener('click', () => {
    window.location.href = 'ticket.html';
  });
  // viewTicketDetails and openTicketsList now exclude status display
  window.viewTicketDetails = async function(ticketId){
    if(!ticketId) return;
    try {
      const t = await backendFetchTicketById(ticketId);
      if(!t){
        addMessage(`Could not find ticket ${ticketId}`, 'bot', true);
        return;
      }
      const html = `<div class="ticket-row">
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(t.title)}</div>
          <div class="ticket-meta">ID: <strong>${escapeHtml(t.ticket_id)}</strong></div>
          <div class="ticket-meta">Created at: <strong>${escapeHtml(formatCreatedAt(t.created_at))}</strong></div>
          <div style="margin-top:6px">${escapeHtml(t.description || '')}</div>
        </div>
        <div style="margin-left:12px">
          <button class="small-btn" onclick="openTicketsList()">All</button>
        </div>
      </div>`;
      addMessage(html, 'bot', true);
    } catch(e){
      console.warn('viewTicketDetails error', e);
      addMessage('Failed to load ticket details.', 'bot', true);
    }
  };
 
  window.openTicketsList = async function(){
    try {
      const list = await backendFetchTickets();
      if(!list || list.length === 0){ addMessage('No tickets found.', 'bot', true); return; }
      let html = '<div style="display:flex;flex-direction:column;gap:8px">';
      list.forEach(t => {
        html += `<div class="ticket-row"><div style="flex:1"><div style="font-weight:700">${escapeHtml(t.title)}</div><div class="ticket-meta">ID: <strong>${escapeHtml(t.ticket_id)}</strong> Â· ${escapeHtml(formatCreatedAt(t.created_at))}</div></div><div><button class="small-btn" onclick="viewTicketDetails('${escapeHtml(t.ticket_id)}')">View</button></div></div>`;
      });
      html += '</div>';
      addMessage(html, 'bot', true);
    } catch(e){
      console.warn('openTicketsList error', e);
      addMessage('Failed to load tickets list.', 'bot', true);
    }
  };
 
  // ======= Load KB from backend or local kbv.json =======
  async function loadKB(){
    const tryBackend = async () => {
      try {
        const resp = await fetch('/api/kb', { cache: 'no-store' });
        if(!resp.ok) throw new Error('backend kb not ok ' + resp.status);
        const data = await resp.json();
        return { source: 'backend', data };
      } catch(e){
        console.warn('Backend KB fetch failed:', e);
        return null;
      }
    };
    const tryLocal = async () => {
      try {
        const resp = await fetch('kbv.json', { cache: 'no-store' });
        if(!resp.ok) throw new Error('local kb not ok ' + resp.status);
        const data = await resp.json();
        return { source: 'local', data };
      } catch(e){
        console.warn('Local KB fetch failed:', e);
        return null;
      }
    };


    let res = await tryBackend();
    if(!res) res = await tryLocal();
    if(!res){
      addMessage('<strong>Error:</strong> Could not load KB from backend (/api/kb) or local (kbv.json). Place kbv.json in the frontend or run the backend to serve /api/kb.', 'bot', true);
      KB = {};
      buildItemsFromKB();
      window.__chatInitialized = true;
      return;
    }
    KB = res.data;
    buildItemsFromKB();
    console.log('KB loaded from', res.source, 'items:', items.length);
    addMessage(`<strong>Knowledge base loaded (${res.source}).</strong> Try asking a question.`, 'bot', true);
    window.__chatInitialized = true;
  }
 
  async function loadPersistedChat(){
    try {
      const msgs = await backendFetchChatMessages(500);
      if(!msgs || msgs.length===0) return;
      window.__renderingPersisted = true;
      msgs.forEach(m => addMessage(m.content, m.role));
      window.__renderingPersisted = false;
    } catch(e){ console.warn('load persisted chat failed', e); }
  }
 
  (async function init(){
    await loadKB();
    await loadHistory();
    await loadPersistedChat();
    setupRecognitionFallbackForTests();
  })();
 
  function startChat(){
    if(!window.__chatHasWelcomed){
      addMessage('<strong>Hello â€” I\\\'m your Helpdesk Assistant.</strong> You can type or use the microphone. Try: \"how to reset password\", \"printer configuration\", or \"how to use SecurePrint\".','bot', true);
      window.__chatHasWelcomed = true;
    }
  }
  window.__chatShowWelcome = startChat;
})();
</script>
 
<!-- If user opens index.html#chat directly, auto-run openChatFull() -->
<script>
if(location.hash === '#chat'){
  window.addEventListener('DOMContentLoaded', ()=> {
    try{ openChatFull(); }catch(e){ console.warn('openChatFull error', e); }
  });
}
/* === Background Change Feature === */

// Load saved background if exists
(function(){
  const saved = localStorage.getItem("custom_bg");
  if (saved) {
    document.body.style.background = `url(${saved}) no-repeat center/cover`;
  }
})();

// Open file explorer
const changeBgBtn = document.getElementById("changeBg");
const modal = document.getElementById("bgLoginModal");
const bgLoginBtn = document.getElementById("bgLoginBtn");
const bgMsg = document.getElementById("bgLoginMsg");

changeBgBtn.addEventListener("click", () => {
  modal.classList.remove("hidden");
  bgMsg.textContent = "";
  document.getElementById("bgUser").focus();
});

bgLoginBtn.addEventListener("click", async () => {
  const username = document.getElementById("bgUser").value.trim();
  const password = document.getElementById("bgPass").value.trim();

  if (!username || !password) {
    bgMsg.textContent = "Enter username and password";
    return;
  }

  try {
    const res = await fetch("/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    if (res.ok) {
      modal.classList.add("hidden");

      // âœ… ONLY NOW open file explorer
      document.getElementById("bgPicker").click();
    } else {
      bgMsg.textContent = "Invalid admin credentials";
    }
  } catch (e) {
    bgMsg.textContent = "Server error";
  }
});



// Handle selected image
document.getElementById("bgPicker").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const imgData = e.target.result;
    document.body.style.background = `url(${imgData}) no-repeat center/cover`;
    localStorage.setItem("custom_bg", imgData);
  };
  reader.readAsDataURL(file);
});
</script>
</body>
</html>
  
 